edition = "2024";

package aks.flex.components.cri;

option go_package = "github.com/Azure/AKSFlexNode/components/cri";

import "components/api/api.proto";

message DownloadCRIBinaries {
  api.Metadata metadata = 1;

  DownloadCRIBinariesSpec spec = 2;

  DownloadCRIBinariesStatus status = 3;
}

message DownloadCRIBinariesSpec {
  string containerd_version = 1;
  string runc_version = 2;
}

message DownloadCRIBinariesStatus {
  string containerd_download_url = 1;
  string containerd_path = 2;
  string runc_download_url = 3;
  string runc_path = 4;
}

message StartContainerdService {
  api.Metadata metadata = 1;
  StartContainerdServiceSpec spec = 2;
  StartContainerdServiceStatus status = 3;
}

message StartContainerdServiceSpec {
  // Address for containerd metrics server to listen on, e.g. 0.0.0.0:10257"
  // Defaults to "0.0.0.0:10257". // FIXME: confirm why 0.0.0.0 is used instead of 127.0.0.1
  string metrics_address = 1;

  // Image used for sandbox container.
  // Defaults to "mcr.microsoft.com/oss/containerd/pause:3.6".
  string sandbox_image = 2;

  CNIConfig cni_config = 3;

  GPUConfig gpu_config = 4;
}

// TODO: allow overriding cni config?
message CNIConfig {
  // CNI plugin directory
  // Defaults to "/opt/cni/bin"
  string bin_dir = 1;

  // CNI config directory
  // Defaults to "/etc/cni/net.d"
  string config_dir = 2;
}

message GPUConfig {
  oneof gpu_config {
    // enable GPU support via Nvidia Container Runtime
    NvidiaRuntime nvidia_runtime = 1;
  }
}

message NvidiaRuntime {
  // Absolute path to the nvidia-container-runtime binary.
  // Defaults to "/usr/bin/nvidia-container-runtime".
  string runtime_path = 1;

  // The runtime class name to use for GPU workloads.
  // Defaults to "nvidia".
  // NOTE: if disable_set_as_default_runtime is false, user is responsible
  // for ensuring the runtime class name object is being created in the cluster,
  // and the workload spec is configured to use the runtime class name,
  // otherwise GPU workload will fail to run.
  string runtime_class_name = 2;

  // Disable the behavior of settings nvidia-container-runtime as the
  // default runtime in containerd config.
  bool disable_set_as_default_runtime = 3;
}

message StartContainerdServiceStatus {
}