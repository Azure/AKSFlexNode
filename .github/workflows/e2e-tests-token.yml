name: E2E Tests (Bootstrap Token Mode)

# Tests the Bootstrap Token authentication mode:
# Create AKS cluster -> Create bootstrap token -> Create VM -> Bootstrap with token -> Verify

on:
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: "Skip cleanup (keep cluster and VM for debugging)"
        required: false
        default: false
        type: boolean

  push:
    tags:
      - "v*"

  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read

jobs:
  # ==========================================================================
  # Job 1: Build Binary
  # ==========================================================================
  build:
    name: Build Binary
    runs-on: [self-hosted, e2e, azure]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Building aks-flex-node binary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VERSION="${GITHUB_REF_NAME:-dev}"
          GIT_COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          LDFLAGS="-X main.Version=${VERSION} -X main.GitCommit=${GIT_COMMIT} -X main.BuildTime=${BUILD_DATE}"
          GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o aks-flex-node .
          chmod +x aks-flex-node

          echo "âœ… Binary built successfully"
          ./aks-flex-node version

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: aks-flex-node-binary-token
          path: aks-flex-node
          retention-days: 1

  # ==========================================================================
  # Job 2: Provision Infrastructure
  # ==========================================================================
  provision-infrastructure:
    name: Provision Infrastructure
    runs-on: [self-hosted, e2e, azure]
    needs: build
    timeout-minutes: 15
    environment: e2e-testing
    outputs:
      cluster-name: ${{ steps.names.outputs.CLUSTER_NAME }}
      vm-name: ${{ steps.names.outputs.VM_NAME }}
      vm-ip: ${{ steps.provision-vm.outputs.VM_IP }}
      cluster-id: ${{ steps.create-cluster.outputs.CLUSTER_ID }}
      server-url: ${{ steps.cluster-info.outputs.SERVER_URL }}
      ca-cert-data: ${{ steps.cluster-info.outputs.CA_CERT_DATA }}

    steps:
      - name: Verify Azure Access
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Verifying Azure Authentication"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          az account show --query "{Subscription:name, User:user.name}" -o table
          echo "âœ… Managed Identity authentication verified"

      - name: Generate unique names
        id: names
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ·ï¸  Generating Test Resource Names"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          TIMESTAMP=$(date +%s)
          CLUSTER_NAME="aks-e2e-token-${TIMESTAMP}"
          VM_NAME="vm-e2e-token-${TIMESTAMP}"

          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "VM_NAME=$VM_NAME" >> $GITHUB_OUTPUT

          echo "Cluster: $CLUSTER_NAME"
          echo "VM:      $VM_NAME"
          echo "âœ… Names generated"

      - name: Create AKS cluster
        id: create-cluster
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜¸ï¸  Creating AKS Cluster"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          START_TIME=$(date +%s)
          CLUSTER_NAME="${{ steps.names.outputs.CLUSTER_NAME }}"

          # Ensure resource group exists
          if ! az group show --name ${{ secrets.E2E_RESOURCE_GROUP }} --output none 2>/dev/null; then
            echo "Resource group '${{ secrets.E2E_RESOURCE_GROUP }}' not found, creating..."
            az group create \
              --name ${{ secrets.E2E_RESOURCE_GROUP }} \
              --location ${{ secrets.E2E_LOCATION }} \
              --tags "purpose=e2e-test" \
              --output none
            echo "âœ… Resource group created"
          else
            echo "âœ… Resource group already exists"
          fi
          echo ""

          az aks create \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $CLUSTER_NAME \
            --location ${{ secrets.E2E_LOCATION }} \
            --enable-managed-identity \
            --enable-aad \
            --enable-azure-rbac \
            --network-plugin azure \
            --node-count 1 \
            --node-vm-size Standard_B2s \
            --generate-ssh-keys \
            --tags "github-run=${{ github.run_id }}" "purpose=e2e-test" "auth-mode=bootstrap-token" \
            --output json > /tmp/cluster-info.json

          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          CLUSTER_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${{ secrets.E2E_RESOURCE_GROUP }}/providers/Microsoft.ContainerService/managedClusters/$CLUSTER_NAME"
          echo "CLUSTER_ID=$CLUSTER_ID" >> $GITHUB_OUTPUT

          DURATION=$(($(date +%s) - START_TIME))
          echo "âœ… AKS cluster created in ${DURATION}s"

          az aks get-credentials \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $CLUSTER_NAME \
            --overwrite-existing \
            --admin

      - name: Extract cluster info
        id: cluster-info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Extracting Cluster Info for Bootstrap Token"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          SERVER_URL=$(kubectl config view --minify -o jsonpath='{.clusters[0].cluster.server}')
          CA_CERT_DATA=$(kubectl config view --minify --raw -o jsonpath='{.clusters[0].cluster.certificate-authority-data}')

          echo "SERVER_URL=$SERVER_URL" >> $GITHUB_OUTPUT
          echo "CA_CERT_DATA=$CA_CERT_DATA" >> $GITHUB_OUTPUT

          echo "Server URL: $SERVER_URL"
          echo "âœ… Cluster info extracted"

      - name: Provision VM (no MSI)
        id: provision-vm
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¥ï¸  Provisioning Test VM (No MSI - Using Bootstrap Token)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          START_TIME=$(date +%s)
          VM_NAME="${{ steps.names.outputs.VM_NAME }}"

          # Note: No --assign-identity flag - this VM uses bootstrap token instead
          az vm create \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $VM_NAME \
            --location ${{ secrets.E2E_LOCATION }} \
            --image Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest \
            --size Standard_B2ms \
            --admin-username azureuser \
            --generate-ssh-keys \
            --public-ip-sku Standard \
            --tags "github-run=${{ github.run_id }}" "purpose=e2e-test" "auth-mode=bootstrap-token" \
            --output json > /tmp/vm-info.json

          VM_IP=$(jq -r '.publicIpAddress' /tmp/vm-info.json)
          echo "VM_IP=$VM_IP" >> $GITHUB_OUTPUT

          DURATION=$(($(date +%s) - START_TIME))
          echo "âœ… VM created in ${DURATION}s"
          echo "IP: $VM_IP"

          echo "Waiting for SSH..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 azureuser@$VM_IP "echo ready" &>/dev/null; then
              echo "âœ… SSH ready"
              break
            fi
            sleep 10
          done

      - name: Save infrastructure info
        run: |
          mkdir -p /tmp/e2e-artifacts
          cat > /tmp/e2e-artifacts/infrastructure.json <<EOF
          {
            "cluster_name": "${{ steps.names.outputs.CLUSTER_NAME }}",
            "vm_name": "${{ steps.names.outputs.VM_NAME }}",
            "vm_ip": "${{ steps.provision-vm.outputs.VM_IP }}",
            "cluster_id": "${{ steps.create-cluster.outputs.CLUSTER_ID }}",
            "server_url": "${{ steps.cluster-info.outputs.SERVER_URL }}",
            "ca_cert_data": "${{ steps.cluster-info.outputs.CA_CERT_DATA }}",
            "subscription_id": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenant_id": "${{ secrets.AZURE_TENANT_ID }}",
            "resource_group": "${{ secrets.E2E_RESOURCE_GROUP }}",
            "location": "${{ secrets.E2E_LOCATION }}"
          }
          EOF

      - name: Upload infrastructure info
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-info-token
          path: /tmp/e2e-artifacts/infrastructure.json
          retention-days: 1

  # ==========================================================================
  # Job 3: Setup Bootstrap Token
  # ==========================================================================
  setup-bootstrap-token:
    name: Setup Bootstrap Token
    runs-on: [self-hosted, e2e, azure]
    needs: provision-infrastructure
    timeout-minutes: 5
    outputs:
      bootstrap-token: ${{ steps.create-token.outputs.BOOTSTRAP_TOKEN }}

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-token
          path: /tmp/

      - name: Get cluster credentials
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Getting Cluster Credentials"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')

          az aks get-credentials \
            --resource-group $RESOURCE_GROUP \
            --name $CLUSTER_NAME \
            --overwrite-existing \
            --admin

      - name: Create bootstrap token
        id: create-token
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ« Creating Bootstrap Token"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Generate token (format: 6 chars . 16 chars)
          TOKEN_ID=$(openssl rand -hex 3)
          TOKEN_SECRET=$(openssl rand -hex 8)
          BOOTSTRAP_TOKEN="${TOKEN_ID}.${TOKEN_SECRET}"

          # 24 hour expiration
          EXPIRATION=$(date -u -d "+24 hours" +"%Y-%m-%dT%H:%M:%SZ")

          echo "Token ID: $TOKEN_ID"
          echo "Expires:  $EXPIRATION"

          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: bootstrap-token-${TOKEN_ID}
            namespace: kube-system
          type: bootstrap.kubernetes.io/token
          stringData:
            description: "AKS Flex Node E2E bootstrap token"
            token-id: "${TOKEN_ID}"
            token-secret: "${TOKEN_SECRET}"
            expiration: "${EXPIRATION}"
            usage-bootstrap-authentication: "true"
            usage-bootstrap-signing: "true"
            auth-extra-groups: "system:bootstrappers:aks-flex-node"
          EOF

          echo "BOOTSTRAP_TOKEN=$BOOTSTRAP_TOKEN" >> $GITHUB_OUTPUT
          echo "âœ… Bootstrap token created"

      - name: Configure RBAC
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”‘ Configuring RBAC for Bootstrap Token"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo "[1/3] Node bootstrapper role binding..."
          kubectl apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: aks-flex-node-bootstrapper
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: system:node-bootstrapper
          subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: system:bootstrappers:aks-flex-node
          EOF

          echo "[2/3] Auto-approve CSR role binding..."
          kubectl apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: aks-flex-node-auto-approve-csr
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
          subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: system:bootstrappers:aks-flex-node
          EOF

          echo "[3/3] Node role binding..."
          kubectl apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: ClusterRoleBinding
          metadata:
            name: aks-flex-node-role
          roleRef:
            apiGroup: rbac.authorization.k8s.io
            kind: ClusterRole
            name: system:node
          subjects:
          - apiGroup: rbac.authorization.k8s.io
            kind: Group
            name: system:bootstrappers:aks-flex-node
          EOF

          echo "âœ… RBAC configured"

  # ==========================================================================
  # Job 4: Bootstrap Flex Node
  # ==========================================================================
  bootstrap-flex-node:
    name: Bootstrap Flex Node
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, setup-bootstrap-token]
    timeout-minutes: 15

    steps:
      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: aks-flex-node-binary-token
          path: /tmp/

      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-token
          path: /tmp/

      - name: Prepare config
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Generating Bootstrap Configuration (Token Mode)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          CLUSTER_ID=$(echo $INFRA | jq -r '.cluster_id')
          SUBSCRIPTION_ID=$(echo $INFRA | jq -r '.subscription_id')
          TENANT_ID=$(echo $INFRA | jq -r '.tenant_id')
          LOCATION=$(echo $INFRA | jq -r '.location')
          SERVER_URL=$(echo $INFRA | jq -r '.server_url')
          CA_CERT_DATA=$(echo $INFRA | jq -r '.ca_cert_data')

          BOOTSTRAP_TOKEN="${{ needs.setup-bootstrap-token.outputs.bootstrap-token }}"

          echo "Server URL: $SERVER_URL"
          echo "Token:      ${BOOTSTRAP_TOKEN:0:6}.******"

          cat > /tmp/config.json <<EOF
          {
            "azure": {
              "subscriptionId": "$SUBSCRIPTION_ID",
              "tenantId": "$TENANT_ID",
              "cloud": "AzurePublicCloud",
              "bootstrapToken": {
                "token": "$BOOTSTRAP_TOKEN"
              },
              "arc": { "enabled": false },
              "targetCluster": {
                "resourceId": "$CLUSTER_ID",
                "location": "$LOCATION"
              }
            },
            "node": {
              "kubelet": {
                "serverURL": "$SERVER_URL",
                "caCertData": "$CA_CERT_DATA"
              }
            },
            "agent": {
              "logLevel": "debug",
              "logDir": "/var/log/aks-flex-node"
            },
            "kubernetes": { "version": "1.35.0" },
            "containerd": { "version": "1.7.13" },
            "runc": { "version": "1.1.12" }
          }
          EOF

          echo "âœ… Configuration generated"

      - name: Upload files and bootstrap
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Running Bootstrap on VM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VM_IP="${{ needs.provision-infrastructure.outputs.vm-ip }}"
          START_TIME=$(date +%s)

          chmod +x /tmp/aks-flex-node
          scp -o StrictHostKeyChecking=no /tmp/aks-flex-node azureuser@$VM_IP:/tmp/aks-flex-node-binary
          scp -o StrictHostKeyChecking=no /tmp/config.json azureuser@$VM_IP:/tmp/

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP 'bash -s' <<'BOOTSTRAP'
          set -euo pipefail

          sudo cp /tmp/aks-flex-node-binary /usr/local/bin/aks-flex-node
          sudo chmod +x /usr/local/bin/aks-flex-node
          aks-flex-node version

          sudo mkdir -p /etc/aks-flex-node /var/log/aks-flex-node
          sudo cp /tmp/config.json /etc/aks-flex-node/

          sudo systemd-run \
            --unit=aks-flex-node-e2e \
            --description="AKS Flex Node E2E Test (Token)" \
            --remain-after-exit \
            /usr/local/bin/aks-flex-node agent --config /etc/aks-flex-node/config.json

          echo "Waiting 60s for bootstrap..."
          sleep 60

          if systemctl is-active --quiet aks-flex-node-e2e; then
            echo "âœ… Agent is running"
          else
            echo "âŒ Agent failed"
            sudo tail -n 50 /var/log/aks-flex-node/aks-flex-node.log
            exit 1
          fi

          sleep 10
          if systemctl is-active --quiet kubelet; then
            echo "âœ… kubelet is running"
          else
            echo "âš ï¸  kubelet status:"
            systemctl status kubelet --no-pager -l || true
          fi
          BOOTSTRAP

          DURATION=$(($(date +%s) - START_TIME))
          echo "âœ… Bootstrap completed in ${DURATION}s"

  # ==========================================================================
  # Job 5: Verify Integration
  # ==========================================================================
  verify-integration:
    name: Verify Integration
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, bootstrap-flex-node]
    if: always() && needs.bootstrap-flex-node.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-token
          path: /tmp/

      - name: Verify node joined cluster
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜¸ï¸  Verifying Node Joined Cluster"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')

          az aks get-credentials \
            --resource-group $RESOURCE_GROUP \
            --name $CLUSTER_NAME \
            --overwrite-existing \
            --admin

          for i in {1..30}; do
            if kubectl get nodes | grep -q "$VM_NAME"; then
              echo "âœ… Node joined cluster"
              kubectl get nodes
              kubectl get node $VM_NAME -o wide
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done

          echo "âŒ Node did not join cluster"
          kubectl get nodes
          echo ""
          echo "Certificate Signing Requests:"
          kubectl get csr || true
          exit 1

      - name: Run smoke test
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Running Smoke Test"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')

          cat > /tmp/test-pod.yaml <<EOF
          apiVersion: v1
          kind: Pod
          metadata:
            name: e2e-smoke-test-token
          spec:
            nodeSelector:
              kubernetes.io/hostname: $VM_NAME
            containers:
            - name: nginx
              image: nginx:alpine
              resources:
                requests: { memory: "64Mi", cpu: "100m" }
                limits: { memory: "128Mi", cpu: "200m" }
          EOF

          kubectl apply -f /tmp/test-pod.yaml

          if kubectl wait --for=condition=Ready pod/e2e-smoke-test-token --timeout=120s; then
            echo "âœ… Smoke test PASSED"
            kubectl get pod e2e-smoke-test-token -o wide
            kubectl delete pod e2e-smoke-test-token
          else
            echo "âŒ Smoke test FAILED"
            kubectl describe pod e2e-smoke-test-token
            exit 1
          fi

  # ==========================================================================
  # Job 6: Collect Logs
  # ==========================================================================
  collect-logs:
    name: Collect Logs
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, bootstrap-flex-node]
    if: always() && needs.provision-infrastructure.result == 'success'
    timeout-minutes: 5

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-token
          path: /tmp/

      - name: Collect logs
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Collecting Logs"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          mkdir -p /tmp/e2e-logs

          INFRA=$(cat /tmp/infrastructure.json)
          VM_IP=$(echo $INFRA | jq -r '.vm_ip')

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo cat /var/log/aks-flex-node/aks-flex-node.log 2>/dev/null" \
            > /tmp/e2e-logs/aks-flex-node.log || true

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u aks-flex-node-e2e -n 200 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/aks-flex-node-e2e.log || true

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u kubelet -n 200 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/kubelet.log || true

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u containerd -n 100 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/containerd.log || true

          echo "âœ… Logs collected"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs-token-${{ github.run_id }}
          path: /tmp/e2e-logs/
          retention-days: 7

  # ==========================================================================
  # Job 7: Cleanup
  # ==========================================================================
  cleanup:
    name: Cleanup
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, bootstrap-flex-node, verify-integration, collect-logs]
    if: always() && needs.provision-infrastructure.result == 'success' && !inputs.skip_cleanup
    timeout-minutes: 10

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-token
          path: /tmp/

      - name: Cleanup resources
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§¹ Cleaning Up Resources"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')

          echo "[1/3] Deleting VM..."
          az vm delete --resource-group $RESOURCE_GROUP --name "$VM_NAME" \
            --force-deletion yes --yes --no-wait || true

          echo "[2/3] Cleaning tagged resources..."
          for type in networkInterfaces publicIPAddresses networkSecurityGroups disks; do
            az resource list --resource-group $RESOURCE_GROUP \
              --query "[?tags.\"github-run\"=='${{ github.run_id }}' && contains(type, '$type')].id" \
              -o tsv | while read -r id; do
                az resource delete --ids "$id" --no-wait 2>/dev/null || true
              done
          done

          echo "[3/3] Deleting AKS cluster..."
          az aks delete --resource-group $RESOURCE_GROUP --name "$CLUSTER_NAME" \
            --yes --no-wait || true

          echo "âœ… Cleanup initiated"

  # ==========================================================================
  # Job 8: Summary
  # ==========================================================================
  summary:
    name: Summary
    runs-on: [self-hosted, e2e, azure]
    needs: [build, provision-infrastructure, setup-bootstrap-token, bootstrap-flex-node, verify-integration]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Generate summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š E2E Test Summary (Bootstrap Token Mode)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Job Results:"
          echo "  Build:           ${{ needs.build.result }}"
          echo "  Provision:       ${{ needs.provision-infrastructure.result }}"
          echo "  Setup Token:     ${{ needs.setup-bootstrap-token.result }}"
          echo "  Bootstrap:       ${{ needs.bootstrap-flex-node.result }}"
          echo "  Verify:          ${{ needs.verify-integration.result }}"
          echo ""

          if [ "${{ needs.provision-infrastructure.result }}" == "success" ]; then
            echo "Resources:"
            echo "  Cluster: ${{ needs.provision-infrastructure.outputs.cluster-name }}"
            echo "  VM:      ${{ needs.provision-infrastructure.outputs.vm-name }}"
            echo ""
          fi

          if [ "${{ needs.setup-bootstrap-token.result }}" == "success" ] && \
             [ "${{ needs.bootstrap-flex-node.result }}" == "success" ] && \
             [ "${{ needs.verify-integration.result }}" == "success" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… E2E Test (Bootstrap Token Mode) PASSED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "Bootstrap Token authentication flow verified:"
            echo "  - Created bootstrap token in kube-system"
            echo "  - Configured RBAC for TLS bootstrapping"
            echo "  - Kubelet obtained client certificate via CSR"
            echo "  - Node joined cluster successfully"
            echo "  - Smoke test passed"
            exit 0
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ E2E Test (Bootstrap Token Mode) FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Check logs: e2e-logs-token-${{ github.run_id }}"
            exit 1
          fi
