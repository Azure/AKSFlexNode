name: E2E Tests (MSI Mode)

# Tests the Managed Identity (MSI) authentication mode:
# Create AKS cluster -> Create VM with MSI -> Grant permissions -> Bootstrap -> Verify

on:
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: "Skip cleanup (keep cluster and VM for debugging)"
        required: false
        default: false
        type: boolean

  push:
    tags:
      - "v*"

  pull_request:
    branches: [main, dev]
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read

jobs:
  # ==========================================================================
  # Job 1: Build Binary
  # ==========================================================================
  build:
    name: Build Binary
    runs-on: [self-hosted, e2e, azure]
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Building aks-flex-node binary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VERSION="${GITHUB_REF_NAME:-dev}"
          GIT_COMMIT=$(git rev-parse --short HEAD)
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          LDFLAGS="-X main.Version=${VERSION} -X main.GitCommit=${GIT_COMMIT} -X main.BuildTime=${BUILD_DATE}"
          GOOS=linux GOARCH=amd64 go build -ldflags "${LDFLAGS}" -o aks-flex-node .
          chmod +x aks-flex-node

          echo "âœ… Binary built successfully"
          ./aks-flex-node version

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: aks-flex-node-binary-msi
          path: aks-flex-node
          retention-days: 1

  # ==========================================================================
  # Job 2: Provision Infrastructure
  # ==========================================================================
  provision-infrastructure:
    name: Provision Infrastructure
    runs-on: [self-hosted, e2e, azure]
    needs: build
    timeout-minutes: 15
    environment: e2e-testing
    outputs:
      cluster-name: ${{ steps.names.outputs.CLUSTER_NAME }}
      vm-name: ${{ steps.names.outputs.VM_NAME }}
      vm-ip: ${{ steps.provision-vm.outputs.VM_IP }}
      vm-msi: ${{ steps.provision-vm.outputs.VM_MSI }}
      cluster-id: ${{ steps.create-cluster.outputs.CLUSTER_ID }}

    steps:
      - name: Verify Azure Access
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Verifying Azure Authentication"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          az account show --query "{Subscription:name, User:user.name}" -o table
          echo "âœ… Managed Identity authentication verified"

      - name: Generate unique names
        id: names
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ·ï¸  Generating Test Resource Names"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          TIMESTAMP=$(date +%s)
          CLUSTER_NAME="aks-e2e-msi-${TIMESTAMP}"
          VM_NAME="vm-e2e-msi-${TIMESTAMP}"

          echo "CLUSTER_NAME=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "VM_NAME=$VM_NAME" >> $GITHUB_OUTPUT

          echo "Cluster: $CLUSTER_NAME"
          echo "VM:      $VM_NAME"
          echo "âœ… Names generated"

      - name: Create AKS cluster
        id: create-cluster
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜¸ï¸  Creating AKS Cluster"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          START_TIME=$(date +%s)
          CLUSTER_NAME="${{ steps.names.outputs.CLUSTER_NAME }}"

          az aks create \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $CLUSTER_NAME \
            --location ${{ secrets.E2E_LOCATION }} \
            --enable-managed-identity \
            --enable-aad \
            --enable-azure-rbac \
            --network-plugin azure \
            --node-count 1 \
            --node-vm-size Standard_B2s \
            --generate-ssh-keys \
            --tags "github-run=${{ github.run_id }}" "purpose=e2e-test" "auth-mode=msi" \
            --output json > /tmp/cluster-info.json

          SUBSCRIPTION_ID=$(az account show --query id -o tsv)
          CLUSTER_ID="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${{ secrets.E2E_RESOURCE_GROUP }}/providers/Microsoft.ContainerService/managedClusters/$CLUSTER_NAME"
          echo "CLUSTER_ID=$CLUSTER_ID" >> $GITHUB_OUTPUT

          DURATION=$(($(date +%s) - START_TIME))
          echo "âœ… AKS cluster created in ${DURATION}s"

          az aks get-credentials \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $CLUSTER_NAME \
            --overwrite-existing \
            --admin

      - name: Provision VM with Managed Identity
        id: provision-vm
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¥ï¸  Provisioning Test VM with MSI"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          START_TIME=$(date +%s)
          VM_NAME="${{ steps.names.outputs.VM_NAME }}"

          az vm create \
            --resource-group ${{ secrets.E2E_RESOURCE_GROUP }} \
            --name $VM_NAME \
            --location ${{ secrets.E2E_LOCATION }} \
            --image Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest \
            --size Standard_B2ms \
            --admin-username azureuser \
            --generate-ssh-keys \
            --public-ip-sku Standard \
            --assign-identity \
            --tags "github-run=${{ github.run_id }}" "purpose=e2e-test" "auth-mode=msi" \
            --output json > /tmp/vm-info.json

          VM_IP=$(jq -r '.publicIpAddress' /tmp/vm-info.json)
          VM_MSI=$(jq -r '.identity.systemAssignedIdentity' /tmp/vm-info.json)

          echo "VM_IP=$VM_IP" >> $GITHUB_OUTPUT
          echo "VM_MSI=$VM_MSI" >> $GITHUB_OUTPUT

          DURATION=$(($(date +%s) - START_TIME))
          echo "âœ… VM created in ${DURATION}s"
          echo "IP: $VM_IP | MSI: $VM_MSI"

          echo "Waiting for SSH..."
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 azureuser@$VM_IP "echo ready" &>/dev/null; then
              echo "âœ… SSH ready"
              break
            fi
            sleep 10
          done

      - name: Save infrastructure info
        run: |
          mkdir -p /tmp/e2e-artifacts
          cat > /tmp/e2e-artifacts/infrastructure.json <<EOF
          {
            "cluster_name": "${{ steps.names.outputs.CLUSTER_NAME }}",
            "vm_name": "${{ steps.names.outputs.VM_NAME }}",
            "vm_ip": "${{ steps.provision-vm.outputs.VM_IP }}",
            "vm_msi": "${{ steps.provision-vm.outputs.VM_MSI }}",
            "cluster_id": "${{ steps.create-cluster.outputs.CLUSTER_ID }}",
            "subscription_id": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenant_id": "${{ secrets.AZURE_TENANT_ID }}",
            "resource_group": "${{ secrets.E2E_RESOURCE_GROUP }}",
            "location": "${{ secrets.E2E_LOCATION }}"
          }
          EOF

      - name: Upload infrastructure info
        uses: actions/upload-artifact@v4
        with:
          name: infrastructure-info-msi
          path: /tmp/e2e-artifacts/infrastructure.json
          retention-days: 1

  # ==========================================================================
  # Job 3: Grant Permissions
  # ==========================================================================
  grant-permissions:
    name: Grant Permissions
    runs-on: [self-hosted, e2e, azure]
    needs: provision-infrastructure
    timeout-minutes: 5

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-msi
          path: /tmp/

      - name: Wait for MSI replication
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â³ Waiting for MSI Replication (30s)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sleep 30
          echo "âœ… MSI should be replicated"

      - name: Grant VM MSI permissions to AKS
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”‘ Granting AKS Permissions to VM MSI"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          VM_MSI=$(echo $INFRA | jq -r '.vm_msi')
          CLUSTER_ID=$(echo $INFRA | jq -r '.cluster_id')

          echo "[1/2] Granting 'Azure Kubernetes Service Cluster Admin Role'..."
          az role assignment create \
            --assignee-object-id $VM_MSI \
            --assignee-principal-type ServicePrincipal \
            --role "Azure Kubernetes Service Cluster Admin Role" \
            --scope "$CLUSTER_ID" \
            --output none

          echo "[2/2] Granting 'Azure Kubernetes Service RBAC Cluster Admin'..."
          az role assignment create \
            --assignee-object-id $VM_MSI \
            --assignee-principal-type ServicePrincipal \
            --role "Azure Kubernetes Service RBAC Cluster Admin" \
            --scope "$CLUSTER_ID" \
            --output none

          echo "Waiting 15s for permission propagation..."
          sleep 15
          echo "âœ… Permissions granted"

      - name: Setup Azure CLI on VM
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš™ï¸  Configuring Azure CLI on VM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VM_IP="${{ needs.provision-infrastructure.outputs.vm-ip }}"

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP 'bash -s' <<'REMOTE'
          set -euo pipefail

          MAX_RETRIES=5
          RETRY_DELAY=15
          for attempt in $(seq 1 $MAX_RETRIES); do
            while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
              sleep 5
            done

            if sudo apt-get update -qq && curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash; then
              echo "âœ… Azure CLI installed"
              break
            fi

            if [ "$attempt" -lt "$MAX_RETRIES" ]; then
              sudo dpkg --configure -a 2>/dev/null || true
              sleep $RETRY_DELAY
            else
              echo "âŒ Azure CLI installation failed"
              exit 1
            fi
          done

          az login --identity --output none
          sudo az login --identity --output none
          echo "âœ… Azure CLI configured with MSI"
          REMOTE

  # ==========================================================================
  # Job 4: Bootstrap Flex Node
  # ==========================================================================
  bootstrap-flex-node:
    name: Bootstrap Flex Node
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, grant-permissions]
    timeout-minutes: 15

    steps:
      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: aks-flex-node-binary-msi
          path: /tmp/

      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-msi
          path: /tmp/

      - name: Prepare config
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Generating Bootstrap Configuration (MSI Mode)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          CLUSTER_ID=$(echo $INFRA | jq -r '.cluster_id')
          SUBSCRIPTION_ID=$(echo $INFRA | jq -r '.subscription_id')
          TENANT_ID=$(echo $INFRA | jq -r '.tenant_id')
          LOCATION=$(echo $INFRA | jq -r '.location')

          cat > /tmp/config.json <<EOF
          {
            "azure": {
              "subscriptionId": "$SUBSCRIPTION_ID",
              "tenantId": "$TENANT_ID",
              "cloud": "AzurePublicCloud",
              "managedIdentity": {},
              "targetCluster": {
                "resourceId": "$CLUSTER_ID",
                "location": "$LOCATION"
              }
            },
            "agent": {
              "logLevel": "debug",
              "logDir": "/var/log/aks-flex-node"
            },
            "kubernetes": { "version": "1.35.0" },
            "containerd": { "version": "1.7.13" },
            "runc": { "version": "1.1.12" }
          }
          EOF

          echo "âœ… Configuration generated"

      - name: Upload files and bootstrap
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Running Bootstrap on VM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          VM_IP="${{ needs.provision-infrastructure.outputs.vm-ip }}"
          START_TIME=$(date +%s)

          chmod +x /tmp/aks-flex-node
          scp -o StrictHostKeyChecking=no /tmp/aks-flex-node azureuser@$VM_IP:/tmp/aks-flex-node-binary
          scp -o StrictHostKeyChecking=no /tmp/config.json azureuser@$VM_IP:/tmp/

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP 'bash -s' <<'BOOTSTRAP'
          set -euo pipefail

          sudo cp /tmp/aks-flex-node-binary /usr/local/bin/aks-flex-node
          sudo chmod +x /usr/local/bin/aks-flex-node
          aks-flex-node version

          sudo mkdir -p /etc/aks-flex-node /var/log/aks-flex-node
          sudo cp /tmp/config.json /etc/aks-flex-node/

          sudo systemd-run \
            --unit=aks-flex-node-e2e \
            --description="AKS Flex Node E2E Test" \
            --remain-after-exit \
            /usr/local/bin/aks-flex-node agent --config /etc/aks-flex-node/config.json

          echo "Waiting 60s for bootstrap..."
          sleep 60

          if systemctl is-active --quiet aks-flex-node-e2e; then
            echo "âœ… Agent is running"
          else
            echo "âŒ Agent failed"
            sudo tail -n 50 /var/log/aks-flex-node/aks-flex-node.log
            exit 1
          fi

          sleep 10
          if systemctl is-active --quiet kubelet; then
            echo "âœ… kubelet is running"
          else
            echo "âš ï¸  kubelet status:"
            systemctl status kubelet --no-pager -l || true
          fi
          BOOTSTRAP

          DURATION=$(($(date +%s) - START_TIME))
          echo "âœ… Bootstrap completed in ${DURATION}s"

  # ==========================================================================
  # Job 5: Verify Integration
  # ==========================================================================
  verify-integration:
    name: Verify Integration
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, bootstrap-flex-node]
    if: always() && needs.bootstrap-flex-node.result == 'success'
    timeout-minutes: 10

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-msi
          path: /tmp/

      - name: Verify node joined cluster
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â˜¸ï¸  Verifying Node Joined Cluster"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')

          az aks get-credentials \
            --resource-group $RESOURCE_GROUP \
            --name $CLUSTER_NAME \
            --overwrite-existing \
            --admin

          for i in {1..30}; do
            if kubectl get nodes | grep -q "$VM_NAME"; then
              echo "âœ… Node joined cluster"
              kubectl get nodes
              kubectl get node $VM_NAME -o wide
              exit 0
            fi
            echo "Waiting... ($i/30)"
            sleep 10
          done

          echo "âŒ Node did not join cluster"
          kubectl get nodes
          exit 1

      - name: Run smoke test
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Running Smoke Test"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')

          cat > /tmp/test-pod.yaml <<EOF
          apiVersion: v1
          kind: Pod
          metadata:
            name: e2e-smoke-test-msi
          spec:
            nodeSelector:
              kubernetes.io/hostname: $VM_NAME
            containers:
            - name: nginx
              image: nginx:alpine
              resources:
                requests: { memory: "64Mi", cpu: "100m" }
                limits: { memory: "128Mi", cpu: "200m" }
          EOF

          kubectl apply -f /tmp/test-pod.yaml

          if kubectl wait --for=condition=Ready pod/e2e-smoke-test-msi --timeout=120s; then
            echo "âœ… Smoke test PASSED"
            kubectl get pod e2e-smoke-test-msi -o wide
            kubectl delete pod e2e-smoke-test-msi
          else
            echo "âŒ Smoke test FAILED"
            kubectl describe pod e2e-smoke-test-msi
            exit 1
          fi

  # ==========================================================================
  # Job 6: Collect Logs
  # ==========================================================================
  collect-logs:
    name: Collect Logs
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, bootstrap-flex-node]
    if: always() && needs.provision-infrastructure.result == 'success'
    timeout-minutes: 5

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-msi
          path: /tmp/

      - name: Collect logs
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Collecting Logs"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          mkdir -p /tmp/e2e-logs

          INFRA=$(cat /tmp/infrastructure.json)
          VM_IP=$(echo $INFRA | jq -r '.vm_ip')

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo cat /var/log/aks-flex-node/aks-flex-node.log 2>/dev/null" \
            > /tmp/e2e-logs/aks-flex-node.log || true

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u aks-flex-node-e2e -n 200 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/aks-flex-node-e2e.log || true

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u kubelet -n 200 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/kubelet.log || true

          ssh -o StrictHostKeyChecking=no azureuser@$VM_IP \
            "sudo journalctl -u containerd -n 100 --no-pager 2>/dev/null" \
            > /tmp/e2e-logs/containerd.log || true

          echo "âœ… Logs collected"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-logs-msi-${{ github.run_id }}
          path: /tmp/e2e-logs/
          retention-days: 7

  # ==========================================================================
  # Job 7: Cleanup
  # ==========================================================================
  cleanup:
    name: Cleanup
    runs-on: [self-hosted, e2e, azure]
    needs: [provision-infrastructure, bootstrap-flex-node, verify-integration, collect-logs]
    if: always() && needs.provision-infrastructure.result == 'success' && !inputs.skip_cleanup
    timeout-minutes: 10

    steps:
      - name: Download infrastructure info
        uses: actions/download-artifact@v4
        with:
          name: infrastructure-info-msi
          path: /tmp/

      - name: Cleanup resources
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§¹ Cleaning Up Resources"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          INFRA=$(cat /tmp/infrastructure.json)
          CLUSTER_NAME=$(echo $INFRA | jq -r '.cluster_name')
          VM_NAME=$(echo $INFRA | jq -r '.vm_name')
          RESOURCE_GROUP=$(echo $INFRA | jq -r '.resource_group')

          echo "[1/3] Deleting VM..."
          az vm delete --resource-group $RESOURCE_GROUP --name "$VM_NAME" \
            --force-deletion yes --yes --no-wait || true

          echo "[2/3] Cleaning tagged resources..."
          for type in networkInterfaces publicIPAddresses networkSecurityGroups disks; do
            az resource list --resource-group $RESOURCE_GROUP \
              --query "[?tags.\"github-run\"=='${{ github.run_id }}' && contains(type, '$type')].id" \
              -o tsv | while read -r id; do
                az resource delete --ids "$id" --no-wait 2>/dev/null || true
              done
          done

          echo "[3/3] Deleting AKS cluster..."
          az aks delete --resource-group $RESOURCE_GROUP --name "$CLUSTER_NAME" \
            --yes --no-wait || true

          echo "âœ… Cleanup initiated"

  # ==========================================================================
  # Job 8: Summary
  # ==========================================================================
  summary:
    name: Summary
    runs-on: [self-hosted, e2e, azure]
    needs: [build, provision-infrastructure, grant-permissions, bootstrap-flex-node, verify-integration]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Generate summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š E2E Test Summary (MSI Mode)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Job Results:"
          echo "  Build:              ${{ needs.build.result }}"
          echo "  Provision:          ${{ needs.provision-infrastructure.result }}"
          echo "  Grant Permissions:  ${{ needs.grant-permissions.result }}"
          echo "  Bootstrap:          ${{ needs.bootstrap-flex-node.result }}"
          echo "  Verify:             ${{ needs.verify-integration.result }}"
          echo ""

          if [ "${{ needs.provision-infrastructure.result }}" == "success" ]; then
            echo "Resources:"
            echo "  Cluster: ${{ needs.provision-infrastructure.outputs.cluster-name }}"
            echo "  VM:      ${{ needs.provision-infrastructure.outputs.vm-name }}"
            echo ""
          fi

          if [ "${{ needs.grant-permissions.result }}" == "success" ] && \
             [ "${{ needs.bootstrap-flex-node.result }}" == "success" ] && \
             [ "${{ needs.verify-integration.result }}" == "success" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… E2E Test (MSI Mode) PASSED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ E2E Test (MSI Mode) FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Check logs: e2e-logs-msi-${{ github.run_id }}"
            exit 1
          fi
